<tool id="kraken" name="Kraken" version="1.0.0">
    <description>
        assign taxonomic labels to short DNA reads.
    </description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <command>
        <![CDATA[
        kraken --threads \${GALAXY_SLOTS:-1} @INPUT_DATABASE@ 
        "$input_sequences"
        #if $split_reads:
            --classified-out "${classified_out}" --unclassified-out "${unclassified_out}"
        #end if
        --output "${output}" &&
        kraken-translate --db ${kraken_database.fields.name} "${output}" > "${translated}"
        #if $draw_histogram:
            && awk '{print \$4}' "${output}" | $__tool_directory__/draw_histogram.py > "${histogram}"
        #end if
        ]]>
    </command>
    <inputs>
        <param format="fasta,fastq,fastqsanger" label="Input sequences" name="input_sequences" type="data" />
        <param label="Output classified and unclassified reads" name="split_reads" type="boolean" />
        <param label="Draw histogram of abundances" name="draw_histogram" type="boolean" />
        <expand macro="input_database" />
    </inputs>
    <outputs>
        <data format="tabular" label="${tool.name} on ${on_string}: Classified reads" name="classified_out">
            <filter>(split_reads)</filter>
        </data>
        <data format="tabular" label="${tool.name} on ${on_string}: Unclassified reads" name="unclassified_out">
            <filter>(split_reads)</filter>
        </data>
        <data format="tabular" label="${tool.name} on ${on_string}: Histogram" name="histogram">
            <filter>(draw_histogram)</filter>
        </data>
        <data format="tabular" label="${tool.name} on ${on_string}: Classification" name="output" />
        <data format="tabular" label="${tool.name} on ${on_string}: Translated classification" name="translated" />
    </outputs>
    <help>
        <![CDATA[
        **What it does**

        A sequence label's score is a fraction C/Q, where C is the number of k-mers mapped to LCA values in the clade rooted at the label, and Q is the number of k-mers in the sequence that lack an ambiguous nucleotide (i.e., they were queried against the database). Consider the example of the LCA mappings in Kraken's output given earlier:

        "562:13 561:4 A:31 0:1 562:3" would indicate that:

            the first 13 k-mers mapped to taxonomy ID #562
            the next 4 k-mers mapped to taxonomy ID #561
            the next 31 k-mers contained an ambiguous nucleotide
            the next k-mer was not in the database
            the last 3 k-mers mapped to taxonomy ID #562

        In this case, ID #561 is the parent node of #562. Here, a label of #562 for this sequence would have a score of C/Q = (13+3)/(13+4+1+3) = 16/21. A label of #561 would have a score of C/Q = (13+4+3)/(13+4+1+3) = 20/21. If a user specified a threshold over 16/21, kraken-filter would adjust the original label from #562 to #561; if the threshold was greater than 20/21, the sequence would become unclassified.

        **Usage**

        kraken-filter is used like this:

        kraken-filter --db $DBNAME [--threshold NUM] kraken.output

        If not specified, the threshold will be 0. kraken-filter's output is similar to kraken's, but a new field between the length and LCA mapping list is present, indicating the new label's score (or the root label's score if the sequence has become unclassified).

        ]]>
    </help>
    <expand macro="requirements" />
    <expand macro="stdio" />
    <expand macro="version_command" />
    <expand macro="citations" />
</tool>